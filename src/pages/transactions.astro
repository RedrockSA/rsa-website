---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Load transactions from content collection, sorted by date descending
const allTransactions = await getCollection('transactions');
const sorted = allTransactions.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Hardcoded filter options
const transactionTypes = [
  'Mergers & Acquisitions',
  'Capital Advisory',
  'Strategic Advisory',
];

const industries = [
  'Consumer',
  'Technology & Business Services',
  'Industrial',
  'Healthcare',
  'Middle Market',
];

const dealFeatures = [
  'Family & Founder-Owned',
  'Public',
  'Private Equity',
  'Cross Border',
  'Strategic Buyer',
];
---

<BaseLayout title="Transactions | Redrock Strategic Advisors" description="Featured transactions and completed deals by Redrock Strategic Advisors.">

  <!-- Hero section -->
  <section
    class="relative bg-cover bg-center bg-no-repeat"
    style="height: 60vh; background-image: url('/iStock-538143827-Adj.jpg');"
  >
    <div class="relative z-10 flex flex-col items-center justify-center h-full text-center text-white px-4">
      <h1 class="text-white mb-4">Completed Transactions & Projects.</h1>
      <p class="text-xl max-w-2xl text-white/90">Proven advisor across a wide range of industries, situations and deal types.</p>
    </div>
  </section>

  <main class="container-wide py-16" style="min-height: 60vh;">

    <!-- Content wrapper — matches the width of the card grid -->
    <div id="transactions-content" class="mx-auto">


    <!-- Intro text -->
    <div class="mb-10">
      <p class="text-lg text-secondary-700 leading-relaxed">
        Redrock Strategic Advisors has a proven track record of advising founders, families and institutional investors across a wide range of industries and transaction types. Below is a selection of our completed and active engagements.
      </p>
    </div>

    <!-- Filter bar + panel -->
    <div id="filter-wrapper" class="mb-8 border border-secondary-200 overflow-hidden">
      <!-- Toggle bar -->
      <div class="flex flex-wrap items-center gap-3 px-5 py-3 bg-secondary-500 cursor-pointer select-none" id="filter-bar">
        <span class="text-white font-bold text-xl md:text-3xl tracking-wide">Selected Transactions</span>
        <div class="ml-auto flex flex-col md:flex-row items-stretch md:items-center gap-2 md:gap-3">
          <button
            id="filter-toggle"
            class="px-4 py-1.5 text-base font-semibold tracking-wide text-white transition-colors"
            style="background-color: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.25);"
          >
            SHOW FILTERS
          </button>
          <button
            id="filter-reset"
            class="px-4 py-1.5 text-base font-semibold tracking-wide transition-colors hidden"
            style="background-color: rgba(255,255,255,0.9); color: #334155; border: 1px solid rgba(255,255,255,0.5);"
          >
            RESET
          </button>
        </div>
      </div>

      <!-- Filter panel (collapsible) -->
      <div id="filter-panel" class="hidden px-6 pb-6 pt-4 bg-secondary-50">
        <div class="filter-columns">
          <!-- Transaction Type -->
          <div>
            <h3 class="text-sm font-semibold tracking-wide text-secondary-600 mb-3 uppercase">Transaction Type</h3>
            <div class="space-y-1">
              {transactionTypes.map((tt) => (
                <label class="flex items-center gap-2 cursor-pointer text-secondary-700 hover:text-secondary-900">
                  <input type="radio" name="transactionType" value={tt} class="accent-[#C80026]" />
                  <span class="text-sm">{tt}</span>
                </label>
              ))}
            </div>
          </div>

          <!-- Industry -->
          <div>
            <h3 class="text-sm font-semibold tracking-wide text-secondary-600 mb-3 uppercase">Industry</h3>
            <div class="space-y-1">
              {industries.map((ind) => (
                <label class="flex items-center gap-2 cursor-pointer text-secondary-700 hover:text-secondary-900">
                  <input type="radio" name="industry" value={ind} class="accent-[#C80026]" />
                  <span class="text-sm">{ind}</span>
                </label>
              ))}
            </div>
          </div>

          <!-- Deal Feature -->
          <div>
            <h3 class="text-sm font-semibold tracking-wide text-secondary-600 mb-3 uppercase">Deal Feature</h3>
            <div class="space-y-1">
              {dealFeatures.map((df) => (
                <label class="flex items-center gap-2 cursor-pointer text-secondary-700 hover:text-secondary-900">
                  <input type="radio" name="dealFeature" value={df} class="accent-[#C80026]" />
                  <span class="text-sm">{df}</span>
                </label>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tombstone grid -->
    <div id="tombstone-grid" class="grid justify-center gap-6" style="grid-template-columns: repeat(auto-fill, 250px);">
      {sorted.map((t) => (
        <div
          class="tombstone-card flex flex-col border border-secondary-200 overflow-hidden transition-all duration-200 hover:border-[#C80026] hover:shadow-[0_0_0_1px_#C80026] bg-white"
          style="width: 250px; height: 300px;"
          data-transaction-type={t.data.transactionType}
          data-industries={t.data.industries.join(',')}
          data-deal-features={t.data.dealFeatures.join(',')}
          data-id={t.slug}
        >
          {/* Transaction type banner */}
          <div class="bg-[#C80026] text-white text-xs font-semibold tracking-wide text-center py-1.5 uppercase">
            {t.data.transactionType}
          </div>

          {/* Client logo / name */}
          <div class="tombstone-logo-area flex items-center justify-center px-4">
            {t.data.clientLogo ? (
              <img
                src={`/logos/${t.data.clientLogo}`}
                alt={t.data.clientName}
                class="max-h-full max-w-full object-contain"
                loading="lazy"
              />
            ) : (
              <span class="text-base font-semibold text-secondary-800 text-center leading-tight">{t.data.clientName}</span>
            )}
          </div>

          {/* Action text — bold when no counterparty */}
          {(() => {
            const hasCounterparty = t.data.counterparties.some(cp => cp.name || cp.logo);
            return (
              <div class="px-4 py-2 text-center">
                <p class={`text-sm text-secondary-600 italic ${hasCounterparty ? '' : 'font-bold'}`}>{t.data.actionText}</p>
              </div>
            );
          })()}

          {/* Counterparty logos / names */}
          <div class={`tombstone-cp-area flex items-center justify-center px-4 ${t.data.counterpartyLayout === 'side-by-side' ? 'flex-row gap-3' : 'flex-col'}`}>
            {t.data.counterparties.map((cp) => (
              <div class="flex items-center justify-center" style={`flex: 1; min-width: 0; ${t.data.counterpartyLayout === 'side-by-side' ? 'height: 100%;' : 'width: 100%;'}`}>
                {cp.logo ? (
                  <img
                    src={`/logos/${cp.logo}`}
                    alt={cp.name}
                    class="max-w-full object-contain"
                    loading="lazy"
                  />
                ) : (
                  <span class="text-sm font-semibold text-secondary-800 text-center leading-tight">{cp.name}</span>
                )}
              </div>
            ))}
          </div>

          <div class="py-2"></div>
        </div>
      ))}
    </div>

    </div><!-- /#transactions-content -->
  </main>
</BaseLayout>

<style>
  .filter-columns {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
  }
  @media (min-width: 768px) {
    .filter-columns {
      grid-template-columns: 1fr 1fr 1fr;
    }
  }

  /* Fixed-height logo zones so action text stays at the same vertical position */
  .tombstone-logo-area {
    height: 100px;
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
  }

  .tombstone-logo-area img {
    max-height: 100%;
    max-width: 100%;
    width: auto;
    height: auto;
  }

  /* Counterparty area fills remaining space and stacks logos */
  .tombstone-cp-area {
    flex: 1;
    min-height: 0;
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
    gap: 0.25rem;
  }

  /* Each counterparty slot has a minimum readable height */
  .tombstone-cp-area > div {
    min-height: 35px;
  }

  .tombstone-cp-area img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    padding-bottom: 0.25rem;
    object-fit: contain;
  }
</style>

<script>
  const toggleBtn = document.getElementById('filter-toggle') as HTMLButtonElement;
  const filterBar = document.getElementById('filter-bar') as HTMLDivElement;
  const resetBtn = document.getElementById('filter-reset') as HTMLButtonElement;
  const filterPanel = document.getElementById('filter-panel') as HTMLDivElement;
  const cards = document.querySelectorAll<HTMLDivElement>('.tombstone-card');
  const radios = filterPanel.querySelectorAll<HTMLInputElement>('input[type="radio"]');

  // Toggle filter panel — clicking the bar or button both work
  filterBar.addEventListener('click', (e) => {
    if ((e.target as HTMLElement).closest('#filter-reset')) return;
    const isHidden = filterPanel.classList.contains('hidden');
    filterPanel.classList.toggle('hidden');
    toggleBtn.textContent = isHidden ? 'HIDE FILTERS' : 'SHOW FILTERS';
  });

  // Apply filters on radio change
  radios.forEach((radio) => {
    radio.addEventListener('change', applyFilters);
  });

  // Reset filters
  resetBtn.addEventListener('click', () => {
    radios.forEach((r) => (r.checked = false));
    applyFilters();
  });

  function applyFilters() {
    const activeTransType = getCheckedValue('transactionType');
    const activeIndustry = getCheckedValue('industry');
    const activeDealFeature = getCheckedValue('dealFeature');

    const hasActiveFilter = !!(activeTransType || activeIndustry || activeDealFeature);
    resetBtn.classList.toggle('hidden', !hasActiveFilter);

    // Show/hide cards
    cards.forEach((card) => {
      const cardTransType = card.dataset.transactionType || '';
      const cardIndustries = (card.dataset.industries || '').split(',');
      const cardDealFeatures = (card.dataset.dealFeatures || '').split(',');

      const matchTrans = !activeTransType
        || (activeTransType === 'Mergers & Acquisitions' && (cardTransType === 'Sell-Side M&A' || cardTransType === 'Buy-Side M&A'))
        || cardTransType === activeTransType;
      // "Middle Market" matches all cards
      const matchIndustry = !activeIndustry || activeIndustry === 'Middle Market' || cardIndustries.includes(activeIndustry);
      const matchFeature = !activeDealFeature || cardDealFeatures.includes(activeDealFeature);

      card.style.display = matchTrans && matchIndustry && matchFeature ? '' : 'none';
    });
  }

  function getCheckedValue(name: string): string {
    const checked = filterPanel.querySelector<HTMLInputElement>(`input[name="${name}"]:checked`);
    return checked ? checked.value : '';
  }

  // Size counterparty logos: enforce a minimum readable height and only
  // cap them when a single counterparty logo would exceed the client logo.
  function sizeCounterpartyLogos(card: HTMLDivElement) {
    const clientImg = card.querySelector<HTMLImageElement>('.tombstone-logo-area img');
    const cpImgs = card.querySelectorAll<HTMLImageElement>('.tombstone-cp-area img');
    if (cpImgs.length === 0) return;

    const MIN_HEIGHT = 35; // never shrink below 35px

    // Only cap when there's a single counterparty that would be taller than the client
    if (clientImg && clientImg.naturalHeight > 0 && cpImgs.length === 1) {
      const clientRenderedH = clientImg.getBoundingClientRect().height;
      const cpRenderedH = cpImgs[0].getBoundingClientRect().height;
      if (cpRenderedH > clientRenderedH) {
        cpImgs[0].style.maxHeight = `${Math.max(clientRenderedH, MIN_HEIGHT)}px`;
      }
    }

    // Enforce minimum height on all counterparty logos
    cpImgs.forEach(img => { img.style.minHeight = `${MIN_HEIGHT}px`; });
  }

  // Run after all images have loaded
  window.addEventListener('load', () => {
    cards.forEach(card => sizeCounterpartyLogos(card));
  });

  // Sync wrapper width to match grid width on desktop
  const contentWrapper = document.getElementById('transactions-content') as HTMLDivElement;
  const grid = document.getElementById('tombstone-grid') as HTMLDivElement;

  function syncContentWidth() {
    // Reset to natural width first so we can measure available space
    contentWrapper.style.maxWidth = '';
    const availableWidth = grid.clientWidth;
    const cardWidth = 250;
    const gap = 24; // 1.5rem = 24px
    // Calculate how many columns fit
    const cols = Math.floor((availableWidth + gap) / (cardWidth + gap));
    if (cols >= 2) {
      const gridWidth = cols * cardWidth + (cols - 1) * gap;
      contentWrapper.style.maxWidth = `${gridWidth}px`;
    }
  }

  syncContentWidth();
  window.addEventListener('resize', syncContentWidth);
</script>
